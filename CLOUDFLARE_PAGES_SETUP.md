# Cloudflare Pages 配置指南

根据您的配置界面截图，以下是需要完成的配置步骤：

## ✅ 已正确配置的部分

1. **构建命令**: `npm run build` ✅
2. **构建输出**: `.next` ✅
3. **生产分支**: `main` ✅
4. **环境变量**: `SESSION_SECRET` 已设置 ✅

## ⚠️ 需要配置的部分

### 1. 添加 D1 数据库绑定（必需）

这是解决构建错误的关键步骤：

1. **在配置界面中**：
   - 找到 **"绑定 (Bindings)"** 部分
   - 点击 **"+ 添加"** 按钮

2. **选择绑定类型**：
   - 选择 **"D1 Database"**

3. **配置 D1 绑定**：
   - **变量名称 (Variable name)**: `DB` （必须使用这个名称，代码中检测的是 `globalThis.DB`）
   - **数据库 (Database)**: 选择您创建的 D1 数据库（`in-nutri-db`）
   - 如果没有数据库，需要先创建：
     ```bash
     wrangler d1 create in-nutri-db
     ```

4. **保存绑定**

### 2. 添加 R2 存储桶绑定（可选，用于文件上传）

如果需要文件上传功能，需要添加 R2 绑定：

1. **点击 "+ 添加"** → 选择 **"R2 Bucket"**

2. **添加三个 R2 绑定**：
   - **变量名称**: `UPLOADS_BUCKET` → 选择 `in-nutri-uploads`
   - **变量名称**: `VIDEOS_BUCKET` → 选择 `in-nutri-videos`
   - **变量名称**: `REPORTS_BUCKET` → 选择 `in-nutri-reports`

### 3. 根目录配置（可选）

如果您的项目不在仓库根目录，可以设置根目录。根据您的配置，根目录是空的，这通常表示使用仓库根目录，这是正确的。

### 4. 环境变量检查

确保以下环境变量已设置：

- ✅ `SESSION_SECRET` - 已设置
- ⚠️ `NEXT_PUBLIC_BASE_URL` - 建议添加（部署后会自动生成，但可以手动设置）

## 📋 完整配置清单

### 必需配置

- [x] 构建命令: `npm run build`
- [x] 构建输出: `.next`
- [x] 生产分支: `main`
- [x] SESSION_SECRET 环境变量
- [ ] **D1 数据库绑定（变量名：`DB`）** ← **这是关键！**

### 可选配置

- [ ] R2 存储桶绑定（如果使用文件上传）
- [ ] NEXT_PUBLIC_BASE_URL 环境变量

## 🔧 创建 D1 数据库（如果还没有）

如果还没有创建 D1 数据库，请执行：

```bash
# 安装 Wrangler（如果还没有）
npm install -g wrangler

# 登录 Cloudflare
wrangler login

# 创建 D1 数据库
wrangler d1 create in-nutri-db
```

创建后会输出数据库 ID，保存它（虽然绑定时会自动选择）。

## 🚀 配置完成后的步骤

1. **保存所有配置**
2. **触发重新部署**：
   - 在 Cloudflare Pages 控制台
   - 找到最新的部署
   - 点击 "Retry deployment" 或等待自动重新部署

3. **验证部署**：
   - 检查构建日志，应该显示最新的提交 `9a2825d`
   - 构建应该成功完成

## ⚠️ 重要提示

**D1 数据库绑定是必需的**，否则代码在运行时无法找到 D1 数据库，会导致错误。

绑定配置后，代码会自动检测到 `globalThis.DB` 并使用 D1 数据库，而不是 SQLite。

## 📝 配置截图说明

根据您的截图：
- ✅ 构建配置正确
- ✅ 环境变量已设置
- ⚠️ **需要添加 D1 数据库绑定**（这是当前问题的根源）

添加 D1 绑定后，重新部署应该就能成功了！






